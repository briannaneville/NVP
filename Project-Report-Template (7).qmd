---
title: "NVP Report"
author: 'Brianna Neville, Curiosity Steen, Hye Jin Park, Michael Basanese'
date: '`r Sys.Date()`'
format: pdf
---

```{r}
#| echo: false
#| include: false
#| label: front-matter
#| warning: false
# clean up & set default chunk options
rm(list = ls())
knitr::opts_chunk$set(echo = FALSE)

# packages
library(readxl)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(lme4)
library(emmeans)
library(knitr)
library(mosaic)
library(ggformula)
library(car)
library(tinytex)

# read in data 

# use this space to do any data processing you need

# load data
foam_raw <- read_excel("Foster_Mines_Capstone_Data_v2.xlsx", sheet = "Sheet1")

# decompose SampleCode
foam_data <- foam_raw %>%
  separate(SampleCode, into = c("prefix", "Chemical_Index", "Porosity", "Sample_ID"), sep = "_", remove = FALSE) %>%
  select(-prefix)

cyc_cols <- grep("^Cyc_", names(foam_data), value = TRUE)
e1_cols <- grep("^E1_MPA_Cyc_", names(foam_data), value = TRUE)
td_cols <- grep("^tandelta_Cyc_", names(foam_data), value = TRUE)
es_cols <- grep("^Estatic_MPA_Cyc_", names(foam_data), value = TRUE)
nvp_cols <- grep("^NVP_Cyc_", names(foam_data), value = TRUE)

meta_cols <- setdiff(names(foam_data), c(cyc_cols, e1_cols, td_cols, es_cols, nvp_cols))

# pivot data
cyc_long <- foam_data %>%
  select(SampleCode, all_of(cyc_cols)) %>%
  pivot_longer(cols = all_of(cyc_cols),
               names_to = "Cycle_Label",
               values_to = "Cycle_Count")

# E1
e1_long <- foam_data %>%
  select(SampleCode, all_of(e1_cols)) %>%
  pivot_longer(cols = all_of(e1_cols),
               names_to = "Cycle_Label",
               values_to = "E1_MPA") %>%
  mutate(Cycle_Label = str_replace(Cycle_Label, "E1_MPA_", ""))

# tandelta
td_long <- foam_data %>%
  select(SampleCode, all_of(td_cols)) %>%
  pivot_longer(cols = all_of(td_cols),
               names_to = "Cycle_Label",
               values_to = "tan_delta") %>%
  mutate(Cycle_Label = str_replace(Cycle_Label, "tandelta_", ""))

# Estatic
es_long <- foam_data %>%
  select(SampleCode, all_of(es_cols)) %>%
  pivot_longer(cols = all_of(es_cols),
               names_to = "Cycle_Label",
               values_to = "Estatic_MPA") %>%
  mutate(Cycle_Label = str_replace(Cycle_Label, "Estatic_MPA_", ""))

# NVP
nvp_long <- foam_data %>%
  select(SampleCode, all_of(nvp_cols)) %>%
  pivot_longer(cols = all_of(nvp_cols),
               names_to = "Cycle_Label",
               values_to = "NVP") %>%
  mutate(Cycle_Label = str_replace(Cycle_Label, "NVP_", ""))

# merge everything
long_data <- cyc_long %>%
  left_join(e1_long, by = c("SampleCode", "Cycle_Label")) %>%
  left_join(td_long, by = c("SampleCode", "Cycle_Label")) %>%
  left_join(es_long, by = c("SampleCode", "Cycle_Label")) %>%
  left_join(nvp_long, by = c("SampleCode", "Cycle_Label"))

# join with meta data
foam_data <- foam_data %>%
  select(all_of(meta_cols)) %>%
  right_join(long_data, by = "SampleCode") %>%
  mutate(
    Chemical_Index = as.numeric(Chemical_Index),
    Porosity = as.numeric(Porosity),
    Sample_ID = as.numeric(Sample_ID),
    Cycle = str_extract(Cycle_Label, "[A-N]$")
  ) %>%
  select(SampleCode, Chemical_Index, Porosity, Sample_ID,
       Cycle, Cycle_Count,
       strain, Stress_kPa, Relporo, freq, amp,
       E1_MPA, tan_delta, Estatic_MPA, NVP)

foam_data <- foam_data %>%
  drop_na()

foam_data <- foam_data %>%
  rename(
    Strain = strain,
    Stress = Stress_kPa,
    Freq = freq,
    Amp = amp,
    Dyn_Stiff = E1_MPA,
    Stat_Stiff = Estatic_MPA,
    Damping = tan_delta
  )

# create new normalized response variable
foam_data <- foam_data %>%
  group_by(SampleCode) %>%
  mutate(
    NVP_Initial = first(NVP[Cycle_Count == min(Cycle_Count, na.rm = TRUE)]),
    NVP_Relative = NVP / NVP_Initial
  ) %>%
  ungroup()

foam_data <- foam_data %>%
  filter(Cycle_Count <= 10000, 
         Damping >= 0,
         !(Sample_ID == 133 & NVP > 0.1)
         )

foam_data <- foam_data %>%
  mutate(Log_Cycle = ifelse(Cycle_Count == 0, 0, log(Cycle_Count)))

```


## 1. Project Description

*Should be in paragraph from (not bullets).  Written for a 3rd party such as your clientâ€™s boss, or an external review board.  As part of your description, consider the following:*

The NNSA is researching new foams to put into Navy helmets. 
Navy personel receive one helmet for their uniform for their entire career in the military. After basic training, the helmet receives a lot of impact, and the helmet takes shocks. Currently, at 10C, the glass transition temp - foam becomes stiff and hard. It performs better when warm. Foam is better energy absorption when its warm. Need to create a foam to be stable across temperatures. There's a comfort layer and firm layer of foam in the helmet. Dr. Moira Foster is tracking the viscoelastic (short term effect) and damage (long term effect) of several different foams.

Changes in material: viscoelastic (short term) and damage (long term). This is what she's tracking. The foams have several different measures:
 - Visco (dampling)
 - Elastic (how squishy it is and bounce back)
The foam is in essence like a memory foam pillow.

She also is observing two densities of foam high (71% air) and low (81% air) porosity. She wants to see how chemical index and porosity affects the foam. There are 6 different foams total to test.

Each foam was intially squished for 120 seconds, and then continuous squishes at certian frequencies and amplitudes determined by Dr. Foster. Sinusoidal squishes. The stress, strain, and relative porosity measured at the beginning of the experiement were also chosen by Dr. Foster and the physical constraints of the foams. After a certain amount of cycles, Dr. Foster measured damping, dynamic elasticity, static elasticicy, and non-linearity.

Want to predict how the effects of the foam change over time with various strains, stresses. 

We were specifically tasked with investigating nonlinear viscous parameter (NVP). Only five papers have been published regarding this parameter. As nonlinearity increases, stiffness compression decreases. 

- *Type of study [Designed experiment, Observational study, Sample survey] and brief description of design*
Designed experiment to squish foam. 


- *Stage of the experiment [Planning stage or Analysis stage]*
Analysis stage

- *Objective of study and role of this analysis*
To test foam for military helmets to absorb impact better.

- *Scope of project*
- *Intended use for results*

## 1.1 Research Questions

*What are the overarching research questions that the client is targeting?*

**Overarching Research Question:** How does stiffness, damping, and nonlinearity change over time and how can we predict this change?  

**For us: **  Which factors in the data are linked to variations in non-linearity?

## 1.2 Variables

*What is (are) possible explanatory and response variables?  Relevant notes about how each is measured/recorded.*

*A table is recommended here. *


*If design is complex, here is a good place to write a detailed description.*

#  2. Exploratory Data Analysis (EDA)

*Description of important variables.*
- *summary statistics*
- *missing Data*
- *unusual or concerning observations*

*Relevant summary figures that provide intuition for the research questions and/or inform important modeling decisions (correlation structure, etc).*

For example, notice the way @fig-example1 shows a scatterplot.

```{r}
#| echo: false
#| label: fig-example1
#| warning: false
#| fig-cap: "Fuel Efficiency as it relates to vehicle weight for a sample of cars."
#| fig-align: "center"
#| fig-width: 3
#| fig-height: 3


data("mtcars")
gf_point(mpg~ wt, data = mtcars)
```

These are interesting remarks about data summaries.  The overall mean fuel economy in the data is `r mean(mtcars$mpg, na.rm = TRUE)` miles per gallon, which I can calculate in-line since it's very simple.  Most code requires a code chunk, but raw code and output should never appear in the body of the report.  Here's a nice table of summary statistics formatted for the report in @tbl-summarystats.

```{r}
#| echo: false
#| label: tbl-summarystats
#| tbl-cap: "Summary Statistics for Engine Displacement by Cylinders"

favstats(disp ~ cyl, data = mtcars) %>%
  knitr::kable()

```

*Describe important outcomes of the EDA that the reader should notice.*

# 3. Statistical Analysis 

```{r, echo=FALSE}
foam_model <- lmer(NVP ~ Log_Cycle + Freq + Amp +
                     as.factor(Chemical_Index) + as.factor(Porosity) + 
                     Log_Cycle:as.factor(Chemical_Index) +
                     (1 + Log_Cycle | Sample_ID), data = foam_data)
```


To investigate the factors affecting the nonlinear viscoelastic parameter (NVP) of helmet foams, we used a **linear mixed effects model**. This approach allowed us to account for the repeated measurements collected from the same foam samples over time. The model selection was finalized by conducting a likelihood ratio tests comparing models with and without different interaction terms, and the final model was selected based on significant improvement in fit and overall simplicity.

The model has **fixed effects** for the logarithm of cycle count, frequency, amplitude, chemical index, porosity, and an interaction between log(cycle) and chemical index. The **random effects** for foam sample ID allows both the baseline NVP and the effect of cycling to vary between samples.

The model equation is:

$$
\begin{aligned}
\text{NVP}_{ij} =\ & a_i + b_i \log(\text{Cycle}_{ij}) + \epsilon_{ij}
\end{aligned}
$$

$$
\begin{aligned}
a_i =\ & \alpha_0 + u_i + \alpha_1 \text{Freq}_{ij} + \alpha_2 \text{Amp}_{ij} \\\\
& + \alpha_3 I(\text{ChemIndex}_{ij}) + \alpha_4 I(\text{Porosity}_{ij})
\end{aligned}
$$

$$
\begin{aligned}
b_i =\ & \beta_0 + v_i + \beta_1 I(\text{ChemIndex}_{ij})
\end{aligned}
$$


where:

- $i$ indexes the foam sample and $j$ indexes the observation within a sample
- $a_{i}$ and $b_{i}$ are the random intercept and slope
- $\alpha_{0}$ and $\beta_{0}$ are the global intercept and slope. In this case, the global intercept represents the initial NVP and the global slope represents the change in NVP as the logarithm of the cycle count increases by one.
- $\epsilon_{ij} \sim N(0, \sigma_\varepsilon^2)$. The parameter $\sigma_\varepsilon^2$ represents the observation-to-observation variability within each sample.
- $u_i$ and $v_i$ follow this distribution:
$$
\left( \begin{array}{c} u_i \\ v_i \end{array} \right) \sim N \left( \left(\begin{array}{c} 0 \\ 0 \end{array} \right), \left(\begin{array}{cc} \sigma_u^2 & \rho_{uv}\sigma_u\sigma_v \\ \rho_{uv}\sigma_u\sigma_v & \sigma_v^2 \end{array} \right) \right)
$$
- $\sigma_u^2$ represents the sample-to-sample variability in the initial NVP
- \sigma_v^2$ represents the sample-to-sample variability in the rate of change in NVP with respect to the logarithm of cycle count
- $\rho_{uv}$ represents the correlation between the initial NVP and the rate of change in NVP with respect to the log of cycle count


### Key Results

The model coefficients are summarized in the table below.

```{r, echo=FALSE}
#| label: tbl-foam-model
#| tbl-cap: "Fixed Effect Estimates and t-values for NVP Model"

foam_model_table <- data.frame(
  Term = c("(Intercept)", "Log(Cycle)", "Frequency", "Amplitude", 
           "Chemical Index = 100", "Chemical Index = 121", "Porosity = 81%", 
           "Log(Cycle) Ã— Chemical Index=100", "Log(Cycle) Ã— Chemical Index=121"),
  Estimate = c(0.00823, 0.00030, 0.00121, 1.40689, 0.00636, 0.02025, 0.02384, 0.00104, 0.00066),
  Std_Error = c(0.00567, 0.00021, 0.00036, 0.15047, 0.00590, 0.00468, 0.00429, 0.00038, 0.00030),
  t_value = c(1.452, 1.442, 3.334, 9.350, 1.078, 4.322, 5.560, 2.734, 2.183)
)

kable(foam_model_table, digits = 3)
```

Variables with t-values greater than the absolute value of 2 are considered statistically significant.

Also, we find that $\hat{\sigma}_u^2 = 3.068e-4$, $\hat{\sigma}_v^2 = 1.222e-6$, $\hat{\sigma}_\varepsilon^2 = 6.852e-6$, and $\rho_{uv} = 0.22$. Since $\hat{\sigma}_u^2$ is much greater than $\hat{\sigma}_v^2$ and $\hat{\sigma}_\varepsilon^2$, most variability in NVP can be attributed to differences in initial NVP between samples. Also, since $\rho_{uv}$ is somewhat small, there is not much correlation between initial NVP and cycle-over-cycle change in NVP.

### Interpretation of Results

We first discuss the meanings of each coefficient estimate:

- Intercept: The expected initial NVP for a sample with chemical index 79, initial porosity of 71%, and a frequency and amplitude of 0 is 0.00823.
- Log(Cycle): Samples with chemical index 79 have an estimated average rate of change in NVP of 0.00030 units per increase of one in log(Cycle).
- Frequency: Holding amplitude, chemical index, and initial porosity constant, as frequency increases by one, the expected initial NVP increases by 0.00121.
- Amplitude: Holding frequency, chemical index, and initial porosity constant, as amplitude increases by one, the expected initial NVP increases by 1.40689.
- Chemical Index = 100: Holding frequency, amplitude, and initial porosity constant, expected initial NVP is 0.00636 units greater for samples with chemical index 100 than for samples with chemical index 79.
- Chemical Index = 121: Holding frequency, amplitude, and initial porosity constant, expected initial NVP is 0.02025 units greater for samples with chemical index 121 than for samples with chemical index 79.
- Porosity = 81%: Holding frequency, amplitude, and chemical index constant, expected initial NVP is 0.02384 units greater for samples with an initial porosity of 81% than for samples with an initial porosity of 71%.
- Log(Cycle) Ã— Chemical Index=100: The estimated average rate of change in NVP per increase of one in log(Cycle) is 0.00104 units higher for samples with chemical index 100 than for samples with chemical index 79.
- Log(Cycle) Ã— Chemical Index=121: The estimated average rate of change in NVP per increase of one in log(Cycle) is 0.00066 units higher for samples with chemical index 121 than for samples with chemical index 79.

We come away with the following conclusions for the effects of the variables in the model on NVP:

- **Amplitude**: Foams tested at larger amplitudes had higher NVP values, meaning they became more resistant under greater amounts of compression.
- **Frequency**: Higher frequencies led to slightly higher NVP values, indicating that faster cycling increases foam resistance.
- **Porosity**: Foams with 81% porosity showed significantly higher NVP than those with 71% porosity.
- **Chemical Index**: Foams with chemical index 121 performed better in terms of maintaining higher NVP compared to chemical index 79.
- **Interaction**: The rate at which NVP changed with cycling depended on the foamâ€™s chemical index. Foams with higher chemical indices tended to maintain higher NVP levels over more cycles.

In our model, we assume linearity and normality of residuals and random effects. The model assumptions were reasonably met and the diagnostic plots can be found in the Appendix.

# 4. Recommendations 

We recommend selecting foams with 81% porosity, as these materials consistently exhibited higher NVP values and are likely to provide better energy absorption in use. In addition, foams with a chemical index of 121 are preferred, since they showed better baseline performance and greater resistance to degradation across cycles. When designing or testing foams, mechanical loading conditions should match expected use. Higher cycling frequencies and larger amplitudes increased NVP, so testing should reflect realistic stress levels. It is also important to consider that chemical formulation affects how quickly NVP declines with repeated use.

# 5. Resources 

*List resources that your client might find useful*

# 6. Additional Considerations

- *Limitations to the recommendations*
- *Concerns you may have about the study; suggestions for similar studies in future*
- *Technical comments*
  

# Technical Appendix  

*Detailed information and a copy of code and or software results.  Additional graphs and supporting figures may also be placed in the appendix.*


### R Script
```{r ref.label=c('front-matter', 'fig-example1','tbl-summarystats', 'fig-example2')}
#| echo: true
#| eval: false

# Reprinted code chunks used previously for analysis
```
